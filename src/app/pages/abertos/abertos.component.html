<section class="page-section" *ngIf="vm$ | async as vm">
  <header class="page-header">
    <div>
      <h2 class="page-title">Chamados Abertos</h2>
      <p class="page-subtitle">Registre novos chamados e acompanhe os atendimentos em aberto.</p>
    </div>
    <span class="status-chip warning">Em aberto: {{ vm.abertos.length }}</span>
  </header>

  <div class="grid-2" *ngIf="vm.carregando">
    <div class="skeleton" style="min-height: 360px;"></div>
    <div class="skeleton" style="min-height: 360px;"></div>
  </div>

  <div class="grid-2" *ngIf="!vm.carregando">
    <article class="card">
      <div class="card-title-row">
        <div>
          <h3 class="card-title">Novo chamado</h3>
          <p class="card-subtitle">Preencha os dados para registrar atendimento.</p>
        </div>
      </div>

      <form class="form" (ngSubmit)="salvar()">
        <label>
          <span>Tipo de cadastro</span>
          <select name="modoCadastro" [(ngModel)]="modoCadastro" (change)="onModoChange()">
            <option value="novo">Chamado novo</option>
            <option value="antigo">Chamado antigo</option>
          </select>
        </label>

        <label>
          <span>Motivo</span>
          <input name="motivo" type="text" [(ngModel)]="motivo" placeholder="Motivo do chamado" />
        </label>

        <label>
          <span>Cliente</span>
          <select name="clienteId" [(ngModel)]="clienteId" (change)="onClienteChange()">
            <option value="">Selecione um cliente</option>
            <option *ngFor="let cliente of vm.clientes" [value]="cliente.id">
              {{ cliente.nome }}
            </option>
            <option value="__novo__">+ Novo cliente</option>
          </select>
        </label>

        <label>
          <span>Data</span>
          <input name="data" type="date" [(ngModel)]="data" />
        </label>

        <label *ngIf="modoCadastro === 'antigo'">
          <span>Como foi resolvido</span>
          <textarea
            name="resolucao"
            rows="3"
            [(ngModel)]="resolucao"
            placeholder="Descreva a resolução"
          ></textarea>
        </label>

        <button class="btn primary" type="submit">Salvar chamado</button>
      </form>
    </article>

    <article class="card">
      <div class="card-title-row">
        <div>
          <h3 class="card-title">Lista de chamados</h3>
          <p class="card-subtitle">Visualize, edite ou finalize chamados abertos.</p>
        </div>
      </div>

      <div class="empty-state" *ngIf="!!vm.erro">{{ vm.erro }}</div>

      <div class="table-wrap" *ngIf="!vm.erro">
        <table class="table abertos-table">
          <colgroup>
            <col class="col-data" />
            <col class="col-cliente" />
            <col class="col-motivo" />
            <col class="col-acoes" />
          </colgroup>
          <thead>
            <tr>
              <th class="col-data">Data</th>
              <th class="col-cliente">Cliente</th>
              <th class="col-motivo">Motivo</th>
              <th class="col-acoes">Ações</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="vm.abertos.length === 0">
              <td colspan="4">Nenhum chamado aberto.</td>
            </tr>
            <tr *ngFor="let item of vm.abertos">
              <td class="col-data">{{ item.data }}</td>
              <td class="col-cliente">{{ item.clienteLabel }}</td>
              <td class="col-motivo">
                <div class="motivo-texto">{{ item.motivo || "-" }}</div>
              </td>
              <td class="col-acoes">
                <div class="btn-group action-buttons">
                  <button class="btn secondary" type="button" (click)="abrirModalEditar(item)">
                    Editar
                  </button>
                  <button class="btn danger" type="button" (click)="excluirChamado(item)">
                    Excluir
                  </button>
                  <button class="btn primary" type="button" (click)="abrirModalFinalizar(item.id!)">
                    Finalizar
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </article>
  </div>

  <div class="modal" *ngIf="modalAberto">
    <div class="modal-content">
      <h3>Finalizar chamado</h3>
      <p class="helper-text">Informe como foi resolvido:</p>
      <textarea
        rows="4"
        [(ngModel)]="resolucaoFinalizar"
        name="resolucaoFinalizar"
        placeholder="Descreva a resolução"
      ></textarea>
      <div class="modal-actions">
        <button class="btn" type="button" (click)="cancelarModal()">Cancelar</button>
        <button class="btn primary" type="button" (click)="confirmarFinalizacao()">Confirmar</button>
      </div>
    </div>
  </div>

  <div class="modal" *ngIf="editando">
    <div class="modal-content">
      <h3>Editar chamado</h3>
      <form class="form" (ngSubmit)="salvarEdicao()">
        <label>
          <span>Motivo</span>
          <input name="editMotivo" type="text" [(ngModel)]="editMotivo" />
        </label>
        <label>
          <span>Cliente</span>
          <div class="helper-text">Atual: {{ editClienteNomeOriginal || "Sem cliente" }}</div>
          <select name="editClienteId" [(ngModel)]="editClienteId">
            <option value="">Selecione um cliente</option>
            <option *ngFor="let cliente of vm.clientes" [value]="cliente.id">
              {{ cliente.nome }}
            </option>
          </select>
        </label>
        <label>
          <span>Data</span>
          <input name="editData" type="date" [(ngModel)]="editData" />
        </label>
        <label *ngIf="editStatus === 'concluido'">
          <span>Descrição da resolução</span>
          <textarea name="editResolucao" rows="3" [(ngModel)]="editResolucao"></textarea>
        </label>
        <div class="modal-actions">
          <button class="btn" type="button" (click)="cancelarEdicao()">Cancelar</button>
          <button class="btn primary" type="submit">Salvar</button>
        </div>
      </form>
    </div>
  </div>
</section>
