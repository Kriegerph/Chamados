<section class="page-section" *ngIf="vm$ | async as vm">
  <header class="page-header">
    <div>
      <h2 class="page-title">Chamados Concluídos</h2>
      <p class="page-subtitle">Filtre e acompanhe o histórico de chamados finalizados.</p>
    </div>
    <label class="field concluidos-limitador">
      <span class="field-label">Exibir</span>
      <select name="pageSize" [(ngModel)]="pageSize" (change)="onPageSizeChange()">
        <option *ngFor="let size of pageSizeOptions" [ngValue]="size">{{ size }}</option>
      </select>
    </label>
  </header>

  <div class="skeleton" style="min-height: 120px;" *ngIf="vm.carregando"></div>

  <article class="card" *ngIf="!vm.carregando">
    <div class="concluidos-header">
      <h3 class="card-title">Filtros</h3>
      <form class="filters-toolbar" (ngSubmit)="aplicarFiltros()">
        <label class="filter-field filter-field--small filter-field--ano" for="filtroAno">
          <span class="field-label">Ano</span>
          <select
            id="filtroAno"
            name="filtroAno"
            [(ngModel)]="filtrosDraft.ano"
            (ngModelChange)="onFiltroDraftChange()"
            (change)="onAnoDraftChange()"
          >
            <option value="">Todos os anos</option>
            <option *ngFor="let ano of anosDisponiveis" [value]="ano">
              {{ ano }}
            </option>
          </select>
        </label>

        <label class="filter-field filter-field--small filter-field--mes" for="filtroMes">
          <span class="field-label">Mês</span>
          <select
            id="filtroMes"
            name="filtroMes"
            [(ngModel)]="filtrosDraft.mes"
            (ngModelChange)="onFiltroDraftChange()"
            [disabled]="!filtrosDraft.ano"
          >
            <option value="">{{ filtrosDraft.ano ? "Todos os meses" : "Selecione o ano" }}</option>
            <option *ngFor="let mes of mesesDisponiveisDraft" [value]="mes.valor">
              {{ mes.label }}
            </option>
          </select>
        </label>

        <label class="filter-field filter-field--data" for="filtroData">
          <span class="field-label">Data específica</span>
          <input
            id="filtroData"
            type="date"
            name="filtroData"
            [(ngModel)]="filtrosDraft.data"
            (ngModelChange)="onFiltroDraftChange()"
            placeholder="Selecione uma data"
          />
        </label>

        <label class="filter-field filter-field--cliente" for="filtroCliente">
          <span class="field-label">Cliente</span>
          <select
            id="filtroCliente"
            name="filtroCliente"
            [(ngModel)]="filtrosDraft.clienteId"
            (ngModelChange)="onFiltroDraftChange()"
          >
            <option value="">Todos os clientes</option>
            <option *ngFor="let cliente of vm.clientes" [value]="cliente.id">
              {{ cliente.nome }}
            </option>
          </select>
        </label>

        <label class="filter-field filter-field--texto" for="filtroTexto">
          <span class="field-label">Texto</span>
          <input
            id="filtroTexto"
            type="search"
            name="filtroTexto"
            [(ngModel)]="filtrosDraft.texto"
            (ngModelChange)="onFiltroDraftChange()"
            placeholder="Motivo, resolução ou descrição"
          />
        </label>

        <div class="filter-actions">
          <button class="btn primary" type="submit">Aplicar</button>
          <button class="btn secondary" type="button" (click)="limparFiltros()">Limpar</button>
        </div>
      </form>
    </div>

    <div class="concluidos-list">
      <div *ngIf="!!vm.erro" class="empty-state">{{ vm.erro }}</div>
      <div *ngIf="!vm.erro && vm.grupos.length === 0" class="empty-state">
        Nenhum chamado concluído.
      </div>

      <div *ngFor="let grupo of vm.grupos" class="concluido-group">
        <h3>{{ grupo.data }}</h3>
        <div *ngFor="let item of grupo.items" class="concluido-item">
          <div class="item-header">
            <strong class="cliente-nome">{{ item.clienteLabel }}</strong>
            <div class="item-badges">
              <span
                class="meta-badge badge-tipo"
                [class.antigo]="item.tipoCadastro === 'antigo'"
                [class.novo]="item.tipoCadastro !== 'antigo'"
              >
                {{ item.tipoCadastro === "antigo" ? "Antigo" : "Novo" }}
              </span>
              <span class="meta-badge badge-hora">{{ formatHora(item) }}</span>
            </div>
          </div>

          <div class="item-body">
            <div class="item-label">Motivo</div>
            <p class="motivo-texto">{{ item.motivo || "Motivo não informado" }}</p>
          </div>

          <div class="item-resolucao">
            <div class="item-label">Descrição da resolução</div>
            <div class="resolucao-box">
              <p>{{ item.resolucao || "Sem resolução informada." }}</p>
            </div>
          </div>

          <div class="item-footer">
            <div class="item-meta-left">Data: {{ item.data || "-" }}</div>
            <div class="concluido-actions">
              <button class="btn secondary" type="button" (click)="abrirModalEditar(item)">
                Editar
              </button>
              <button class="btn danger" type="button" (click)="excluirChamado(item)">
                Excluir
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="concluidos-pagination-wrap" *ngIf="!vm.erro && vm.totalItems > 0">
      <div class="concluidos-pagination-meta">
        Exibindo {{ vm.inicioIntervalo }}-{{ vm.fimIntervalo }} de {{ vm.totalItems }} concluídos
      </div>

      <nav class="concluidos-pagination" aria-label="Paginação de chamados concluídos">
        <button
          class="btn pagination-btn"
          type="button"
          (click)="irParaPrimeiraPagina(vm.totalPages)"
          [disabled]="vm.currentPage <= 1"
        >
          Primeiro
        </button>
        <button
          class="btn pagination-btn"
          type="button"
          (click)="irParaPaginaAnterior(vm.totalPages)"
          [disabled]="vm.currentPage <= 1"
        >
          Anterior
        </button>

        <ng-container *ngFor="let page of vm.pageButtons; trackBy: trackByPageButton">
          <span class="pagination-ellipsis" *ngIf="page === '...'">...</span>
          <button
            *ngIf="page !== '...'"
            class="btn pagination-btn pagination-btn-number"
            type="button"
            [class.active]="page === vm.currentPage"
            [disabled]="page === vm.currentPage"
            (click)="irParaPagina(page, vm.totalPages)"
          >
            {{ page }}
          </button>
        </ng-container>

        <button
          class="btn pagination-btn"
          type="button"
          (click)="irParaProximaPagina(vm.totalPages)"
          [disabled]="vm.totalPages === 0 || vm.currentPage >= vm.totalPages"
        >
          Próximo
        </button>
        <button
          class="btn pagination-btn"
          type="button"
          (click)="irParaUltimaPagina(vm.totalPages)"
          [disabled]="vm.totalPages === 0 || vm.currentPage >= vm.totalPages"
        >
          Último
        </button>
      </nav>
    </div>
  </article>

  <div class="modal" *ngIf="editando">
    <div class="modal-content">
      <h3>Editar chamado</h3>
      <form class="form" (ngSubmit)="salvarEdicao()">
        <label>
          <span>Motivo</span>
          <input name="editMotivo" type="text" [(ngModel)]="editMotivo" />
        </label>
        <label>
          <span>Cliente</span>
          <div class="helper-text">Atual: {{ editClienteNomeOriginal || "Sem cliente" }}</div>
          <select name="editClienteId" [(ngModel)]="editClienteId">
            <option value="">Selecione um cliente</option>
            <option *ngFor="let cliente of vm.clientes" [value]="cliente.id">
              {{ cliente.nome }}
            </option>
          </select>
        </label>
        <label>
          <span>Data</span>
          <input name="editData" type="date" [(ngModel)]="editData" />
        </label>
        <label>
          <span>Descrição da resolução</span>
          <textarea name="editResolucao" rows="3" [(ngModel)]="editResolucao"></textarea>
        </label>
        <div class="modal-actions">
          <button class="btn" type="button" (click)="cancelarEdicao()">Cancelar</button>
          <button class="btn primary" type="submit">Salvar</button>
        </div>
      </form>
    </div>
  </div>
</section>
